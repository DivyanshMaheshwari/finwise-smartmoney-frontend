<div
  class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-6 relative"
>
  <!-- Loading Overlay -->
  <div
    *ngIf="loading"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex flex-col justify-center items-center"
  >
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"
    ></div>
    <p class="mt-4 text-lg text-teal-300 font-medium">Saving income...</p>
  </div>

  <!-- Income Form -->
  <div
    class="max-w-5xl mx-auto bg-white/5 p-8 rounded-xl shadow-md border border-white/10 mb-12"
  >
    <h2 class="text-2xl font-bold mb-6 text-teal-300">Add Income</h2>

    <form
      #incomeForm="ngForm"
      (ngSubmit)="submitIncome()"
      class="space-y-6"
      novalidate
    >
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Amount -->
        <div>
          <label class="block text-sm font-medium mb-1">Amount *</label>
          <input
            type="number"
            [(ngModel)]="income.amount"
            name="amount"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="Enter amount"
          />
        </div>

        <!-- Date -->
        <div>
          <label class="block text-sm font-medium mb-1">Date *</label>
          <input
            type="date"
            [(ngModel)]="income.date"
            name="date"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
          />
        </div>

        <!-- Category -->
        <div>
          <label class="block text-sm font-medium mb-1">Category *</label>
          <input
            type="text"
            [(ngModel)]="income.category"
            name="category"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="e.g., Salary, Freelance"
          />
        </div>

        <!-- Source -->
        <div>
          <label class="block text-sm font-medium mb-1">Source *</label>
          <input
            type="text"
            [(ngModel)]="income.source"
            name="source"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="e.g., Company, Client"
          />
        </div>

        <!-- Recurring Checkbox -->
        <div class="flex items-center space-x-2">
          <input
            type="checkbox"
            [(ngModel)]="income.isRecurring"
            name="isRecurring"
            (change)="onRecurringToggle()"
            class="form-checkbox h-5 w-5 text-teal-500"
          />
          <span>Recurring Income</span>
        </div>

        <!-- Note -->
        <div class="md:col-span-2 lg:col-span-3">
          <label class="block text-sm font-medium mb-1">Note (optional)</label>
          <textarea
            [(ngModel)]="income.note"
            name="note"
            rows="2"
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2 resize-none"
            placeholder="Any additional note..."
          ></textarea>
        </div>

        <!-- Recurring Fields -->
        <ng-container *ngIf="income.isRecurring">
          <div>
            <label class="block text-sm font-medium mb-1">Frequency *</label>
            <select
              [(ngModel)]="income.frequency"
              name="frequency"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            >
              <option value="WEEKLY">Weekly</option>
              <option value="MONTHLY">Monthly</option>
              <option value="YEARLY">Yearly</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1"
              >Recurring Day *</label
            >
            <input
              type="number"
              [(ngModel)]="income.recurringDay"
              name="recurringDay"
              required
              min="1"
              max="31"
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              placeholder="e.g., 15 for 15th of the month"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">End Date *</label>
            <input
              type="date"
              [(ngModel)]="income.endDate"
              name="endDate"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            />
          </div>
        </ng-container>
      </div>

      <!-- Submit -->
      <div class="flex justify-end">
        <button
          type="submit"
          [disabled]="
            incomeForm.invalid || (income.isRecurring && !income.frequency)
          "
          class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-6 py-2 rounded-md transition shadow disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Add Income
        </button>
      </div>
    </form>
  </div>

  <!-- Income List -->
  <div class="max-w-6xl mx-auto">
    <div
      class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4"
    >
      <h2 class="text-2xl font-bold text-white">Income Records</h2>

      <!-- Month-Year Dropdown -->
      <div class="flex items-center space-x-4">
        <select
          [(ngModel)]="selectedMonth"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option
            *ngFor="
              let month of [
                { name: 'January', value: 1 },
                { name: 'February', value: 2 },
                { name: 'March', value: 3 },
                { name: 'April', value: 4 },
                { name: 'May', value: 5 },
                { name: 'June', value: 6 },
                { name: 'July', value: 7 },
                { name: 'August', value: 8 },
                { name: 'September', value: 9 },
                { name: 'October', value: 10 },
                { name: 'November', value: 11 },
                { name: 'December', value: 12 }
              ]
            "
            [value]="month.value"
          >
            {{ month.name }}
          </option>
        </select>

        <select
          [(ngModel)]="selectedYear"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option *ngFor="let year of [2023, 2024, 2025, 2026]" [value]="year">
            {{ year }}
          </option>
        </select>
      </div>
    </div>

    <!-- Loading -->
    <div
      *ngIf="incomeListLoading"
      class="text-center py-12 text-teal-400 text-lg animate-pulse"
    >
      Loading income records...
    </div>

    <!-- No Data -->
    <div
      *ngIf="!incomeListLoading && incomeList.length === 0"
      class="text-gray-400 text-center py-12"
    >
      No income entries found for {{ selectedMonth }}/{{ selectedYear }}.
    </div>

    <!-- List -->
    <div *ngIf="!incomeListLoading && incomeList.length > 0" class="grid gap-6">
      <div
        *ngFor="let income of incomeList"
        class="w-full bg-white/5 p-6 rounded-xl border border-white/10 shadow transition hover:shadow-lg relative"
      >
        <!-- Delete Icon or Spinner -->
        <ng-container *ngIf="!deletingIds.has(income.id); else deleting">
          <button
            (click)="confirmDelete(income.id)"
            class="absolute top-4 right-4 text-red-400 hover:text-red-600 transition"
            title="Delete"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M6 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                clip-rule="evenodd"
              />
              <path
                fill-rule="evenodd"
                d="M4 5a1 1 0 011-1h10a1 1 0 011 1v1H4V5zm2 3h8v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </ng-container>
        <ng-template #deleting>
          <div class="absolute top-4 right-4">
            <div
              class="h-5 w-5 border-2 border-t-transparent border-teal-400 rounded-full animate-spin"
            ></div>
          </div>
        </ng-template>

        <!-- Income Info -->
        <div
          class="grid md:grid-cols-3 gap-4 text-sm md:text-base text-gray-300"
        >
          <p>
            <span class="font-semibold text-teal-300">Amount:</span> â‚¹{{
              income.amount
            }}
          </p>
          <p><span class="font-semibold">Date:</span> {{ income.date }}</p>
          <p>
            <span class="font-semibold">Category:</span> {{ income.category }}
          </p>
          <p><span class="font-semibold">Source:</span> {{ income.source }}</p>
          <p>
            <span class="font-semibold">Note:</span> {{ income.note || "-" }}
          </p>
          <p>
            <span class="font-semibold">Recurring:</span>
            {{ income.isRecurring ? "Yes" : "No" }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <app-confirmation-modal
    [show]="showConfirmModal"
    [title]="'Delete Income'"
    [message]="'Are you sure you want to delete this income entry?'"
    [loading]="isDeleting"
    (confirm)="deleteIncome(pendingDeleteId!)"
    (cancel)="cancelDelete()"
  ></app-confirmation-modal>
</div>
