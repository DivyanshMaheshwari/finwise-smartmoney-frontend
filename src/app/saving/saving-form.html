<div
  class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-6 relative"
>
  <!-- Loading Overlay -->
  <div
    *ngIf="loading"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex flex-col justify-center items-center"
  >
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"
    ></div>
    <p class="mt-4 text-lg text-teal-300 font-medium">Saving...</p>
  </div>

  <!-- Saving Form -->
  <div
    class="max-w-5xl mx-auto bg-white/5 p-8 rounded-xl shadow-md border border-white/10 mb-12"
  >
    <h2 class="text-2xl font-bold mb-6 text-teal-300">Add Saving</h2>
    <div class="flex justify-center mb-8 space-x-4">
      <button
        (click)="activeTab = 'add'"
        [ngClass]="{
          'bg-teal-600 text-white': activeTab === 'add',
          'bg-gray-700 text-gray-300': activeTab !== 'add'
        }"
        class="px-4 py-2 rounded-md font-semibold"
      >
        Add Saving
      </button>
      <button
        (click)="activeTab = 'use'"
        [ngClass]="{
          'bg-teal-600 text-white': activeTab === 'use',
          'bg-gray-700 text-gray-300': activeTab !== 'use'
        }"
        class="px-4 py-2 rounded-md font-semibold"
      >
        Use Saving
      </button>
      <button
        (click)="activeTab = 'total'"
        [ngClass]="{
          'bg-teal-600 text-white': activeTab === 'total',
          'bg-gray-700 text-gray-300': activeTab !== 'total'
        }"
        class="px-4 py-2 rounded-md font-semibold"
      >
        Total Saving
      </button>
    </div>
    <div *ngIf="activeTab === 'add'">
      <form
        #savingForm="ngForm"
        (ngSubmit)="submitSaving()"
        class="space-y-6"
        novalidate
      >
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Amount -->
          <div>
            <label class="block text-sm font-medium mb-1">Amount *</label>
            <input
              type="number"
              [(ngModel)]="saving.amount"
              name="amount"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              placeholder="Enter amount"
            />
          </div>

          <!-- Date -->
          <div>
            <label class="block text-sm font-medium mb-1">Date *</label>
            <input
              type="date"
              [(ngModel)]="saving.date"
              name="date"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            />
          </div>

          <!-- Category -->
          <div>
            <label class="block text-sm font-medium mb-1">Category *</label>
            <select
              [(ngModel)]="saving.category"
              name="category"
              (change)="onCategoryChange(saving.category)"
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              required
            >
              <option value="" disabled selected>Select Category</option>
              <option *ngFor="let cat of category" [value]="cat">
                {{ cat }}
              </option>
            </select>
          </div>

          <!-- Custom Category -->
          <div *ngIf="showCustomCategory">
            <label class="block text-sm font-medium mb-1 mt-1"
              >Specify Category *</label
            >
            <input
              type="text"
              [(ngModel)]="saving.category"
              name="customCategory"
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              placeholder="Enter custom category"
              required
            />
          </div>

          <!-- Note -->
          <div class="md:col-span-2 lg:col-span-3">
            <label class="block text-sm font-medium mb-1"
              >Note (optional)</label
            >
            <textarea
              [(ngModel)]="saving.note"
              name="note"
              rows="2"
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2 resize-none"
              placeholder="Any additional note..."
            ></textarea>
          </div>

          <!-- Recurring Checkbox -->
          <div class="flex items-center space-x-2">
            <input
              type="checkbox"
              [(ngModel)]="saving.isRecurring"
              name="isRecurring"
              (change)="onRecurringToggle()"
              class="form-checkbox h-5 w-5 text-teal-500"
            />
            <span>Recurring Saving</span>
          </div>

          <!-- Recurring Fields -->
          <ng-container *ngIf="saving.isRecurring">
            <div>
              <label class="block text-sm font-medium mb-1">Frequency *</label>
              <select
                [(ngModel)]="saving.frequency"
                name="frequency"
                required
                class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              >
                <option value="WEEKLY">Weekly</option>
                <option value="MONTHLY">Monthly</option>
                <option value="YEARLY">Yearly</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1"
                >Recurring Day *</label
              >
              <input
                type="number"
                [(ngModel)]="saving.recurringDay"
                name="recurringDay"
                required
                min="1"
                max="31"
                class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
                placeholder="e.g., 10 for 10th"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">End Date *</label>
              <input
                type="date"
                [(ngModel)]="saving.endDate"
                name="endDate"
                required
                class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              />
            </div>
          </ng-container>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            [disabled]="
              savingForm.invalid || (saving.isRecurring && !saving.frequency)
            "
            class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-6 py-2 rounded-md transition shadow disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Add Saving
          </button>
        </div>
      </form>
    </div>
    <div *ngIf="activeTab === 'use'" class="max-w-5xl mx-auto text-gray-300">
      <!-- TODO: Add Use Saving form here -->
      <p class="text-center text-lg">Use saving feature coming soon...</p>
    </div>

    <div *ngIf="activeTab === 'total'" class="max-w-5xl mx-auto text-gray-300">
      <!-- TODO: Add Total Saving breakdown here -->
      <p class="text-center text-lg">Total saving breakdown coming soon...</p>
    </div>
  </div>

  <!-- Saving List -->
  <div class="max-w-6xl mx-auto">
    <div
      class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4"
    >
      <h2 class="text-2xl font-bold text-white">Saving Records</h2>

      <!-- Month-Year Selector -->
      <div class="flex items-center space-x-4">
        <select
          [(ngModel)]="selectedMonth"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option
            *ngFor="
              let month of [
                'January',
                'February',
                'March',
                'April',
                'May',
                'June',
                'July',
                'August',
                'September',
                'October',
                'November',
                'December'
              ];
              let i = index
            "
            [value]="i + 1"
          >
            {{ month }}
          </option>
        </select>

        <select
          [(ngModel)]="selectedYear"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option
            *ngFor="let year of [2023, 2024, 2025, 2026, 2027, 2028]"
            [value]="year"
          >
            {{ year }}
          </option>
        </select>
      </div>
    </div>

    <!-- Loading -->
    <div
      *ngIf="savingListLoading"
      class="text-center py-12 text-teal-400 text-lg animate-pulse"
    >
      Loading saving records...
    </div>

    <!-- No Data -->
    <div
      *ngIf="!savingListLoading && savingList.length === 0"
      class="text-gray-400 text-center py-12"
    >
      No saving entries found for {{ selectedMonth }}/{{ selectedYear }}.
    </div>

    <!-- Saving Items -->
    <div *ngIf="!savingListLoading && savingList.length > 0" class="grid gap-6">
      <div
        *ngFor="let item of savingList"
        class="w-full bg-white/5 p-6 rounded-xl border border-white/10 shadow transition hover:shadow-lg relative"
      >
        <!-- Delete Icon or Spinner -->
        <ng-container *ngIf="!deletingIds.has(item.id); else deletingSaving">
          <button
            (click)="confirmDelete(item.id)"
            class="absolute top-4 right-4 text-red-400 hover:text-red-600 transition"
            title="Delete"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M6 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                clip-rule="evenodd"
              />
              <path
                fill-rule="evenodd"
                d="M4 5a1 1 0 011-1h10a1 1 0 011 1v1H4V5zm2 3h8v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </ng-container>

        <!-- Spinner while deleting -->
        <ng-template #deletingSaving>
          <div class="absolute top-4 right-4">
            <div
              class="h-5 w-5 border-2 border-t-transparent border-teal-400 rounded-full animate-spin"
            ></div>
          </div>
        </ng-template>

        <!-- Saving Info -->
        <div
          class="grid md:grid-cols-3 gap-4 text-sm md:text-base text-gray-300"
        >
          <p>
            <span class="font-semibold text-teal-300">Amount:</span> â‚¹{{
              item.amount
            }}
          </p>
          <p><span class="font-semibold">Date:</span> {{ item.date }}</p>
          <p>
            <span class="font-semibold">Category:</span> {{ item.category }}
          </p>
          <p><span class="font-semibold">Note:</span> {{ item.note }}</p>
          <p>
            <span class="font-semibold">Recurring:</span>
            {{ item.isRecurring ? "Yes" : "No" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <app-confirmation-modal
      [show]="showConfirmModal"
      [title]="'Delete Saving'"
      [message]="'Are you sure you want to delete this saving entry?'"
      [confirmText]="'Delete'"
      [cancelText]="'Cancel'"
      [loading]="isDeleting"
      (confirm)="deleteSaving(pendingDeleteId!)"
      (cancel)="cancelDelete()"
    ></app-confirmation-modal>
  </div>
</div>
