<div
  class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-6 relative"
>
  <!-- Loading Overlay -->
  <div
    *ngIf="loading"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex flex-col justify-center items-center"
  >
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"
    ></div>
    <p class="mt-4 text-lg text-teal-300 font-medium">Saving expense...</p>
  </div>

  <!-- Confirmation Modal -->
  <app-confirmation-modal
    [show]="showConfirmModal"
    (confirm)="deleteExpense(pendingDeleteId!)"
    (cancel)="cancelDelete()"
    message="Are you sure you want to delete this expense?"
    confirmText="Delete"
    cancelText="Cancel"
    [loading]="isDeleting"
  ></app-confirmation-modal>

  <!-- Expense Form -->
  <div
    class="max-w-5xl mx-auto bg-white/5 p-8 rounded-xl shadow-md border border-white/10 mb-12"
  >
    <h2 class="text-2xl font-bold mb-6 text-teal-300">Add Expense</h2>

    <form
      #expenseForm="ngForm"
      (ngSubmit)="submitExpense()"
      class="space-y-6"
      novalidate
    >
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Amount -->
        <div>
          <label class="block text-sm font-medium mb-1">Amount *</label>
          <input
            type="number"
            [(ngModel)]="expense.amount"
            name="amount"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="Enter amount"
          />
        </div>

        <!-- Date -->
        <div>
          <label class="block text-sm font-medium mb-1">Date *</label>
          <input
            type="date"
            [(ngModel)]="expense.date"
            name="date"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
          />
        </div>

        <!-- Category -->
        <!-- Category -->
        <div>
          <label class="block text-sm font-medium mb-1">Category *</label>
          <select
            [(ngModel)]="expense.category"
            name="category"
            (change)="onCategoryChange(expense.category)"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
          >
            <option value="" disabled selected>Select Category</option>
            <option *ngFor="let cat of categoryList" [value]="cat">
              {{ cat }}
            </option>
          </select>
        </div>

        <!-- Custom Category Input -->
        <div *ngIf="showCustomCategory">
          <label class="block text-sm font-medium mb-1 mt-1"
            >Enter Custom Category *</label
          >
          <input
            type="text"
            [(ngModel)]="customCategory"
            name="customCategory"
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="e.g., Shopping, Gym"
            required
          />
        </div>

        <!-- Type Dropdown -->
        <div>
          <label class="block text-sm font-medium mb-1">Expense Type *</label>
          <select
            [(ngModel)]="expense.type"
            name="type"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
          >
            <option value="" disabled selected>Select Type</option>
            <option value="Needs">Needs</option>
            <option value="Wants">Wants</option>
          </select>
        </div>

        <!-- Payment Mode -->
        <div>
          <label class="block text-sm font-medium mb-1">Payment Mode *</label>
          <select
            [(ngModel)]="selectedPaymentMode"
            (change)="onPaymentModeChange()"
            name="paymentModeSelect"
            required
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
          >
            <option value="" disabled selected>Select Payment Mode</option>
            <option value="UPI">UPI</option>
            <option value="Card">Card</option>
            <option value="Cash">Cash</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Custom Payment Mode Input -->
        <div *ngIf="selectedPaymentMode === 'Other'">
          <label class="block text-sm font-medium mb-1 mt-1"
            >Enter Payment Mode *</label
          >
          <input
            type="text"
            [(ngModel)]="customPaymentMode"
            name="customPaymentMode"
            (input)="updateCustomPaymentMode()"
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            placeholder="e.g., Bank Transfer"
            required
          />
        </div>

        <!-- Recurring Checkbox -->
        <div class="flex items-center space-x-2">
          <input
            type="checkbox"
            [(ngModel)]="expense.isRecurring"
            name="isRecurring"
            (change)="onRecurringToggle()"
            class="form-checkbox h-5 w-5 text-teal-500"
          />
          <span>Recurring Expense</span>
        </div>

        <!-- Note -->
        <div class="md:col-span-2 lg:col-span-3">
          <label class="block text-sm font-medium mb-1">Note (optional)</label>
          <textarea
            [(ngModel)]="expense.note"
            name="note"
            rows="2"
            class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2 resize-none"
            placeholder="Any additional note..."
          ></textarea>
        </div>

        <!-- Recurring Fields -->
        <ng-container *ngIf="expense.isRecurring">
          <div>
            <label class="block text-sm font-medium mb-1">Frequency *</label>
            <select
              [(ngModel)]="expense.frequency"
              name="frequency"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            >
              <option value="WEEKLY">Weekly</option>
              <option value="MONTHLY">Monthly</option>
              <option value="YEARLY">Yearly</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1"
              >Recurring Day *</label
            >
            <input
              type="number"
              [(ngModel)]="expense.recurringDay"
              name="recurringDay"
              required
              min="1"
              max="31"
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
              placeholder="e.g., 5 for 5th of the month"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">End Date *</label>
            <input
              type="date"
              [(ngModel)]="expense.endDate"
              name="endDate"
              required
              class="w-full rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
            />
          </div>
        </ng-container>
      </div>

      <!-- Submit -->
      <div class="flex justify-end">
        <button
          type="submit"
          [disabled]="
            expenseForm.invalid || (expense.isRecurring && !expense.frequency)
          "
          class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-6 py-2 rounded-md transition shadow disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Add Expense
        </button>
      </div>
    </form>
  </div>

  <!-- Expense List -->
  <div class="max-w-6xl mx-auto">
    <div
      class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4"
    >
      <h2 class="text-2xl font-bold text-white">Expense Records</h2>

      <!-- Month-Year Dropdown -->
      <div class="flex items-center space-x-4">
        <select
          [(ngModel)]="selectedMonth"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option
            *ngFor="
              let month of [
                { name: 'January', value: 1 },
                { name: 'February', value: 2 },
                { name: 'March', value: 3 },
                { name: 'April', value: 4 },
                { name: 'May', value: 5 },
                { name: 'June', value: 6 },
                { name: 'July', value: 7 },
                { name: 'August', value: 8 },
                { name: 'September', value: 9 },
                { name: 'October', value: 10 },
                { name: 'November', value: 11 },
                { name: 'December', value: 12 }
              ]
            "
            [value]="month.value"
          >
            {{ month.name }}
          </option>
        </select>

        <select
          [(ngModel)]="selectedYear"
          (ngModelChange)="
            onMonthYearChange({ month: selectedMonth, year: selectedYear })
          "
          class="rounded-md bg-gray-800 text-white border border-white/20 px-4 py-2"
        >
          <option *ngFor="let year of [2023, 2024, 2025, 2026]" [value]="year">
            {{ year }}
          </option>
        </select>
      </div>
    </div>

    <!-- Loading -->
    <div
      *ngIf="expenseListLoading"
      class="text-center py-12 text-teal-400 text-lg animate-pulse"
    >
      Loading expense records...
    </div>

    <!-- No Data -->
    <div
      *ngIf="!expenseListLoading && expenseList.length === 0"
      class="text-gray-400 text-center py-12"
    >
      No expense entries found for {{ selectedMonth }}/{{ selectedYear }}.
    </div>

    <!-- List -->
    <div
      *ngIf="!expenseListLoading && expenseList.length > 0"
      class="grid gap-6"
    >
      <div
        *ngFor="let expense of expenseList"
        class="w-full bg-white/5 p-6 rounded-xl border border-white/10 shadow transition hover:shadow-lg relative"
      >
        <ng-container *ngIf="!deletingIds.has(expense.id); else deleting">
          <button
            (click)="confirmDelete(expense.id)"
            class="absolute top-4 right-4 text-red-400 hover:text-red-600 transition"
            title="Delete"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M6 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                clip-rule="evenodd"
              />
              <path
                fill-rule="evenodd"
                d="M4 5a1 1 0 011-1h10a1 1 0 011 1v1H4V5zm2 3h8v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </ng-container>
        <ng-template #deleting>
          <div class="absolute top-4 right-4">
            <div
              class="h-5 w-5 border-2 border-t-transparent border-teal-400 rounded-full animate-spin"
            ></div>
          </div>
        </ng-template>

        <div
          class="grid md:grid-cols-3 gap-4 text-sm md:text-base text-gray-300"
        >
          <p>
            <span class="font-semibold text-teal-300">Amount:</span> ₹{{
              expense.amount
            }}
          </p>
          <p>
            <span class="font-semibold">Date:</span>
            {{ expense.date | date : "dd-MMM-yyyy" }}
          </p>
          <p>
            <span class="font-semibold">Category:</span> {{ expense.category }}
          </p>
          <p><span class="font-semibold">Type:</span> {{ expense.type }}</p>
          <p>
            <span class="font-semibold">Payment:</span>
            {{ expense.paymentMode }}
          </p>
          <p>
            <span class="font-semibold">Recurring:</span>
            {{ expense.isRecurring ? "Yes" : "No" }}
          </p>
          <p>
            <span class="font-semibold">Note:</span> {{ expense.note || "-" }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
